<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Transferir √çndice de Series de Firebase a Cloudflare</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f9ff;
      color: #333;
    }
    
    h2 {
      color: #1a73e8;
      text-align: center;
      margin-bottom: 25px;
      font-size: 28px;
    }
    
    .container {
      max-width: 1600px;
      margin: 0 auto;
      background-color: white;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    
    .card {
      background-color: white;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    
    .card h3 {
      margin-top: 0;
      color: #1a73e8;
      border-bottom: 1px solid #e0e9ff;
      padding-bottom: 10px;
    }
    
    .controls {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 10px;
    }
    
    button {
      padding: 12px 20px;
      background-color: #1a73e8;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 2px 5px rgba(26, 115, 232, 0.3);
    }
    
    button:hover {
      background-color: #1557b0;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(26, 115, 232, 0.3);
    }
    
    button:active {
      transform: translateY(0);
    }
    
    button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    #btnTransferir {
      background-color: #34a853;
    }
    
    #btnTransferir:hover {
      background-color: #2d9249;
    }
    
    #btnLimpiar {
      background-color: #ea4335;
    }
    
    #btnLimpiar:hover {
      background-color: #d33426;
    }
    
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 20px;
      background-color: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    
    th, td {
      border: 1px solid #e0e9ff;
      padding: 12px;
      text-align: left;
    }
    
    th {
      background-color: #1a73e8;
      color: white;
      font-weight: 600;
    }
    
    tr:nth-child(even) {
      background-color: #f8fbff;
    }
    
    tr:hover {
      background-color: #e8f1ff;
    }
    
    .progress-container {
      margin: 15px 0;
      background: #f1f5f9;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    .progress-bar-wrapper {
      width: 100%;
      height: 20px;
      background: #e0e7ff;
      border-radius: 10px;
      overflow: hidden;
    }
    
    .progress-bar {
      height: 100%;
      width: 0;
      background: linear-gradient(90deg, #3b82f6, #1d4ed8);
      border-radius: 10px;
      transition: width 0.4s ease;
      box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
    }
    
    .progress-text {
      margin-top: 10px;
      font-weight: 600;
      color: #1e40af;
      text-align: center;
    }
    
    .stats {
      display: flex;
      justify-content: space-between;
      margin-top: 20px;
    }
    
    .stat-box {
      background-color: #e8f1ff;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      flex: 1;
      margin: 0 10px;
    }
    
    .stat-box h4 {
      margin: 0 0 10px 0;
      color: #1a73e8;
    }
    
    .stat-value {
      font-size: 24px;
      font-weight: bold;
      color: #1a73e8;
    }
    
    .filter-section {
      margin-bottom: 20px;
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      align-items: center;
    }
    
    .filter-section label {
      font-weight: 500;
      color: #1a73e8;
    }
    
    .filter-section input, .filter-section select {
      padding: 8px 12px;
      border: 2px solid #d3e3fd;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.3s;
      box-sizing: border-box;
    }
    
    .filter-section input:focus, .filter-section select:focus {
      border-color: #1a73e8;
      box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.2);
      outline: none;
    }
    
    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-top: 20px;
      gap: 10px;
    }
    
    .pagination button {
      padding: 8px 16px;
      font-size: 14px;
    }
    
    .pagination-info {
      margin: 0 15px;
      font-weight: 500;
      color: #1a73e8;
    }
    
    .loading-progress {
      margin: 15px 0;
    }
    
    .loading-progress .progress-bar-wrapper {
      height: 10px;
    }
    
    .loading-progress .progress-text {
      font-size: 14px;
      margin-top: 5px;
    }
    
    .table-container {
      max-height: 600px;
      overflow-y: auto;
      margin-bottom: 20px;
    }
    
    .debug-info {
      background-color: #fff3cd;
      border: 1px solid #ffeaa7;
      border-radius: 8px;
      padding: 15px;
      margin-top: 20px;
      font-family: monospace;
      font-size: 12px;
      max-height: 200px;
      overflow-y: auto;
    }
    
    .image-preview {
      max-width: 80px;
      max-height: 60px;
      border-radius: 4px;
      object-fit: cover;
    }
    
    .link-cell {
      max-width: 150px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .text-cell {
      max-width: 120px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .actions {
      display: flex;
      gap: 5px;
    }
    
    .actions button {
      padding: 6px 10px;
      font-size: 12px;
    }
    
    .badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      margin: 2px;
    }
    
    .badge-categoria {
      background-color: #e1f5fe;
      color: #01579b;
    }
    
    .badge-idioma {
      background-color: #f3e5f5;
      color: #4a148c;
    }
    
    .badge-a√±o {
      background-color: #e8f5e8;
      color: #1b5e20;
    }
    
    .search-section {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 15px;
    }
    
    .search-field {
      flex: 1;
      min-width: 200px;
    }
    
    .search-field input {
      width: 100%;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Transferir √çndice de Series de Firebase a Cloudflare</h2>
    
    <div class="card">
      <h3>Configuraci√≥n</h3>
      <div class="controls">
        <button id="btnCargarFirebase">Cargar √çndice de Firebase</button>
        <button id="btnTransferir" disabled>Transferir a Cloudflare</button>
        <button id="btnLimpiar">Limpiar Tabla</button>
      </div>
      
      <!-- Barra de progreso para carga de Firebase -->
      <div id="loadingProgress" class="loading-progress" style="display: none;">
        <div class="progress-bar-wrapper">
          <div id="loadingProgressBar" class="progress-bar"></div>
        </div>
        <div id="loadingProgressText" class="progress-text">0%</div>
      </div>
      
      <div class="search-section">
        <div class="search-field">
          <label for="filterSerie">Filtrar por Serie:</label>
          <input type="text" id="filterSerie" placeholder="Nombre de la serie">
        </div>
        
        <div class="search-field">
          <label for="filterNombreIngles">Filtrar por Nombre Ingl√©s:</label>
          <input type="text" id="filterNombreIngles" placeholder="Nombre en ingl√©s">
        </div>
        
        <div class="search-field">
          <label for="filterNombreJapones">Filtrar por Nombre Japon√©s:</label>
          <input type="text" id="filterNombreJapones" placeholder="Nombre en japon√©s">
        </div>
        
        <div class="search-field">
          <label for="filterCategoria">Filtrar por Categor√≠a:</label>
          <input type="text" id="filterCategoria" placeholder="Categor√≠a">
        </div>
      </div>
      
      <div class="filter-section">
        <button id="btnAplicarFiltro">Aplicar Filtros</button>
        <button id="btnLimpiarFiltro">Limpiar Filtros</button>
      </div>
    </div>
    
    <div class="card">
      <h3>√çndice de Series de Firebase</h3>
      <div class="table-container">
        <div id="tablaDatos"></div>
      </div>
      
      <!-- Paginaci√≥n -->
      <div id="pagination" class="pagination" style="display: none;">
        <button id="btnFirstPage">Primera</button>
        <button id="btnPrevPage">Anterior</button>
        <span id="paginationInfo" class="pagination-info"></span>
        <button id="btnNextPage">Siguiente</button>
        <button id="btnLastPage">√öltima</button>
      </div>
    </div>
    
    <!-- Barra de progreso para transferencia a Cloudflare -->
    <div id="transferProgress" class="progress-container" style="display: none;">
      <div class="progress-bar-wrapper">
        <div id="transferProgressBar" class="progress-bar"></div>
      </div>
      <div id="transferProgressText" class="progress-text">0%</div>
    </div>
    
    <div class="stats">
      <div class="stat-box">
        <h4>Series Totales</h4>
        <div class="stat-value" id="statSeries">0</div>
      </div>
      <div class="stat-box">
        <h4>Categor√≠as √önicas</h4>
        <div class="stat-value" id="statCategorias">0</div>
      </div>
      <div class="stat-box">
        <h4>Idiomas</h4>
        <div class="stat-value" id="statIdiomas">0</div>
      </div>
      <div class="stat-box">
        <h4>A√±os Diferentes</h4>
        <div class="stat-value" id="statAnios">0</div>
      </div>
    </div>

    <!-- Informaci√≥n de depuraci√≥n -->
    <div class="card">
      <h3>Informaci√≥n de Depuraci√≥n</h3>
      <button id="btnToggleDebug">Mostrar/Ocultar Informaci√≥n de Depuraci√≥n</button>
      <div id="debugInfo" class="debug-info" style="display: none;">
        <div id="debugContent"></div>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

  <script>
    // Configuraci√≥n de Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyB6MY2y5uyum87PdUHUpY8NNh4D73Yhx4U",
      authDomain: "animes-plus-89b93.firebaseapp.com",
      projectId: "animes-plus-89b93",
      storageBucket: "animes-plus-89b93.appspot.com",
      messagingSenderId: "402867181985",
      appId: "1:402867181985:web:d695b12977fe4270dbd3e0",
      measurementId: "G-DN632G7XJT"
    };

    // Inicializar Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Variables globales
    let datosFirebase = [];
    let datosFiltrados = [];
    let currentPage = 1;
    const itemsPerPage = 10;

    // Cargar datos de Firebase
    document.getElementById('btnCargarFirebase').addEventListener('click', cargarDatosFirebase);

    async function cargarDatosFirebase() {
      try {
        const btnCargar = document.getElementById('btnCargarFirebase');
        btnCargar.disabled = true;
        btnCargar.textContent = 'Cargando...';
        
        // Mostrar barra de progreso de carga
        const loadingProgress = document.getElementById('loadingProgress');
        const loadingProgressBar = document.getElementById('loadingProgressBar');
        const loadingProgressText = document.getElementById('loadingProgressText');
        loadingProgress.style.display = 'block';
        
        datosFirebase = [];
        
        // Obtener todas las series de la colecci√≥n "animes-series-indice"
        const seriesSnapshot = await db.collection("animes-series-indice").get();
        const totalSeries = seriesSnapshot.size;
        let seriesProcesadas = 0;
        
        for (const serieDoc of seriesSnapshot.docs) {
          const nombreSerie = serieDoc.id;
          const datosSerie = serieDoc.data();
          
          datosFirebase.push({
            nombreSerie,
            nombreIngles: datosSerie.nombresec || '',
            nombreJapones: datosSerie.nombresec02 || '',
            anio: datosSerie.a√±o || '',
            categoria: datosSerie.categoria || '',
            idioma: datosSerie.idioma || '',
            imagen: datosSerie.imagen || '',
            sitio: datosSerie.sitio || ''
          });
          
          // Actualizar progreso
          seriesProcesadas++;
          const progressPercent = Math.round((seriesProcesadas / totalSeries) * 100);
          loadingProgressBar.style.width = `${progressPercent}%`;
          loadingProgressText.textContent = `${progressPercent}% (${seriesProcesadas}/${totalSeries} series)`;
        }
        
        datosFiltrados = [...datosFirebase];
        currentPage = 1;
        mostrarDatosEnTabla();
        actualizarEstadisticas();
        actualizarPaginacion();
        
        document.getElementById('btnTransferir').disabled = false;
        btnCargar.disabled = false;
        btnCargar.textContent = 'Cargar √çndice de Firebase';
        loadingProgress.style.display = 'none';
        
        alert(`Se cargaron ${datosFirebase.length} series del √≠ndice de Firebase.`);
        
      } catch (error) {
        console.error("Error al cargar datos de Firebase:", error);
        alert("Error al cargar datos de Firebase: " + error.message);
        
        const btnCargar = document.getElementById('btnCargarFirebase');
        btnCargar.disabled = false;
        btnCargar.textContent = 'Cargar √çndice de Firebase';
        document.getElementById('loadingProgress').style.display = 'none';
      }
    }

    // Mostrar datos en tabla con paginaci√≥n
    function mostrarDatosEnTabla() {
      const tablaDatos = document.getElementById('tablaDatos');
      
      if (datosFiltrados.length === 0) {
        tablaDatos.innerHTML = '<p>No hay datos para mostrar.</p>';
        document.getElementById('pagination').style.display = 'none';
        return;
      }
      
      // Calcular √≠ndices para la p√°gina actual
      const startIndex = (currentPage - 1) * itemsPerPage;
      const endIndex = Math.min(startIndex + itemsPerPage, datosFiltrados.length);
      const datosPagina = datosFiltrados.slice(startIndex, endIndex);
      
      const tablaHTML = `
        <table>
          <thead>
            <tr>
              <th>Serie</th>
              <th>Nombre Ingl√©s</th>
              <th>Nombre Japon√©s</th>
              <th>A√±o</th>
              <th>Categor√≠a</th>
              <th>Idioma</th>
              <th>Imagen</th>
              <th>Sitio</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            ${datosPagina.map(d => `
              <tr>
                <td><strong>${escapeHTML(d.nombreSerie)}</strong></td>
                <td class="text-cell">${escapeHTML(d.nombreIngles)}</td>
                <td class="text-cell">${escapeHTML(d.nombreJapones)}</td>
                <td>
                  ${d.anio ? `<span class="badge badge-a√±o">${escapeHTML(d.anio)}</span>` : ''}
                </td>
                <td>
                  ${d.categoria ? `<span class="badge badge-categoria">${escapeHTML(d.categoria)}</span>` : ''}
                </td>
                <td>
                  ${d.idioma ? `<span class="badge badge-idioma">${escapeHTML(d.idioma)}</span>` : ''}
                </td>
                <td>
                  ${d.imagen ? `
                    <img src="${escapeHTML(d.imagen)}" alt="Portada" class="image-preview" 
                         onerror="this.style.display='none'">
                    <div class="link-cell">${truncateText(escapeHTML(d.imagen), 20)}</div>
                  ` : 'Sin imagen'}
                </td>
                <td class="link-cell">${truncateText(escapeHTML(d.sitio), 30)}</td>
                <td class="actions">
                  <button onclick="verDetalles('${escapeHTML(d.nombreSerie)}')">Ver</button>
                  <button onclick="probarImagen('${escapeHTML(d.imagen)}')">Imagen</button>
                  <button onclick="probarSitio('${escapeHTML(d.sitio)}')">Sitio</button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
      
      tablaDatos.innerHTML = tablaHTML;
      document.getElementById('pagination').style.display = 'flex';
    }

    // Funciones auxiliares para acciones
    function verDetalles(serie) {
      const datos = datosFiltrados.find(d => d.nombreSerie === serie);
      if (datos) {
        const detalles = `
Detalles de: ${serie}

‚Ä¢ Nombre en Ingl√©s: ${datos.nombreIngles || 'No disponible'}
‚Ä¢ Nombre en Japon√©s: ${datos.nombreJapones || 'No disponible'}
‚Ä¢ A√±o: ${datos.anio || 'No disponible'}
‚Ä¢ Categor√≠a: ${datos.categoria || 'No disponible'}
‚Ä¢ Idioma: ${datos.idioma || 'No disponible'}
‚Ä¢ Imagen: ${datos.imagen || 'No disponible'}
‚Ä¢ Sitio: ${datos.sitio || 'No disponible'}
        `;
        alert(detalles);
      }
    }

    function probarImagen(url) {
      if (!url) {
        alert('No hay URL de imagen para probar');
        return;
      }
      
      const ventana = window.open('', '_blank');
      ventana.document.write(`
        <html>
          <head><title>Prueba de Imagen - ${url.substring(0, 30)}...</title></head>
          <body style="display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; background: #f5f5f5;">
            <div style="text-align: center; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
              <h2>Prueba de Imagen</h2>
              <img src="${url}" alt="Imagen de prueba" 
                   style="max-width: 90vw; max-height: 70vh; border: 1px solid #ccc; border-radius: 5px;"
                   onerror="this.src='https://via.placeholder.com/400x300?text=Error+al+cargar+imagen'">
              <p style="margin-top: 20px; word-break: break-all; max-width: 600px;">URL: ${url}</p>
              <button onclick="window.close()" style="margin-top: 10px; padding: 10px 20px; background: #1a73e8; color: white; border: none; border-radius: 5px; cursor: pointer;">Cerrar</button>
            </div>
          </body>
        </html>
      `);
    }

    function probarSitio(url) {
      if (!url) {
        alert('No hay URL de sitio para probar');
        return;
      }
      
      window.open(url, '_blank');
    }

    // Actualizar controles de paginaci√≥n
    function actualizarPaginacion() {
      const totalPages = Math.ceil(datosFiltrados.length / itemsPerPage);
      const paginationInfo = document.getElementById('paginationInfo');
      
      paginationInfo.textContent = `P√°gina ${currentPage} de ${totalPages} (${datosFiltrados.length} registros)`;
      
      // Habilitar/deshabilitar botones
      document.getElementById('btnFirstPage').disabled = currentPage === 1;
      document.getElementById('btnPrevPage').disabled = currentPage === 1;
      document.getElementById('btnNextPage').disabled = currentPage === totalPages;
      document.getElementById('btnLastPage').disabled = currentPage === totalPages;
    }

    // Event listeners para paginaci√≥n
    document.getElementById('btnFirstPage').addEventListener('click', function() {
      currentPage = 1;
      mostrarDatosEnTabla();
      actualizarPaginacion();
    });

    document.getElementById('btnPrevPage').addEventListener('click', function() {
      if (currentPage > 1) {
        currentPage--;
        mostrarDatosEnTabla();
        actualizarPaginacion();
      }
    });

    document.getElementById('btnNextPage').addEventListener('click', function() {
      const totalPages = Math.ceil(datosFiltrados.length / itemsPerPage);
      if (currentPage < totalPages) {
        currentPage++;
        mostrarDatosEnTabla();
        actualizarPaginacion();
      }
    });

    document.getElementById('btnLastPage').addEventListener('click', function() {
      const totalPages = Math.ceil(datosFiltrados.length / itemsPerPage);
      currentPage = totalPages;
      mostrarDatosEnTabla();
      actualizarPaginacion();
    });

    // Funci√≥n para escapar HTML
    function escapeHTML(str) {
      if (!str) return '';
      return str
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    // Funci√≥n para truncar texto
    function truncateText(text, maxLength) {
      if (!text) return '';
      if (text.length <= maxLength) return text;
      return text.substring(0, maxLength) + '...';
    }

    // Actualizar estad√≠sticas
    function actualizarEstadisticas() {
      const series = datosFiltrados.length;
      const categorias = new Set(datosFiltrados.map(d => d.categoria).filter(Boolean));
      const idiomas = new Set(datosFiltrados.map(d => d.idioma).filter(Boolean));
      const anios = new Set(datosFiltrados.map(d => d.anio).filter(Boolean));
      
      document.getElementById('statSeries').textContent = series;
      document.getElementById('statCategorias').textContent = categorias.size;
      document.getElementById('statIdiomas').textContent = idiomas.size;
      document.getElementById('statAnios').textContent = anios.size;
    }

    // Transferir datos a Cloudflare
    document.getElementById('btnTransferir').addEventListener('click', transferirACloudflare);

    async function transferirACloudflare() {
      if (datosFiltrados.length === 0) {
        alert("No hay datos para transferir.");
        return;
      }

      const total = datosFiltrados.length;
      const chunkSize = 50;
      let processed = 0;

      const transferProgress = document.getElementById('transferProgress');
      const transferProgressBar = document.getElementById('transferProgressBar');
      const transferProgressText = document.getElementById('transferProgressText');
      
      transferProgress.style.display = "block";
      transferProgressBar.style.width = "0%";
      transferProgressText.innerText = "0%";

      const btnTransferir = document.getElementById('btnTransferir');
      btnTransferir.disabled = true;
      btnTransferir.textContent = 'Transferiendo...';

      try {
        for (let i = 0; i < total; i += chunkSize) {
          const chunk = datosFiltrados.slice(i, i + chunkSize);

          // MOSTRAR INFORMACI√ìN DE DEPURACI√ìN
          actualizarDebugInfo(`Enviando lote ${Math.floor(i/chunkSize) + 1}:`, chunk);

          // Enviar datos a Cloudflare
          let response;
          try {
            for (const indice of chunk) {
  actualizarDebugInfo(`üì§ Enviando: ${indice.nombreSerie}`);

  const result = await enviarIndice(indice);

  if (result.ok) {
    actualizarDebugInfo(`‚úÖ Registrada: ${indice.nombreSerie}`);
  } else {
    actualizarDebugInfo(`‚ùå Error con ${indice.nombreSerie}: ${result.error}`);
  }
}
          } catch (error) {
           for (const indice of chunk) {
  actualizarDebugInfo(`üì§ Enviando: ${indice.nombreSerie}`);

  const result = await enviarIndice(indice);

  if (result.ok) {
    actualizarDebugInfo(`‚úÖ Registrada: ${indice.nombreSerie}`);
  } else {
    actualizarDebugInfo(`‚ùå Error con ${indice.nombreSerie}: ${result.error}`);
  }
}
          }

          if (!response.ok) {
            const errorText = await response.text();
            actualizarDebugInfo(`Error en respuesta: ${errorText}`);
            throw new Error(errorText);
          }

          const result = await response.json();
          actualizarDebugInfo(`Lote ${Math.floor(i/chunkSize) + 1} procesado:`, result);

          processed += chunk.length;
          const percent = Math.round((processed / total) * 100);
          transferProgressBar.style.width = `${percent}%`;
          transferProgressText.innerText = `${percent}%`;
        }

        alert("‚úÖ √çndice de series transferido exitosamente a Cloudflare.");
        
        // Limpiar despu√©s de la transferencia
        setTimeout(() => {
          transferProgress.style.display = "none";
          btnTransferir.disabled = false;
          btnTransferir.textContent = 'Transferir a Cloudflare';
        }, 1000);

      } catch (error) {
        console.error("Error al transferir a Cloudflare:", error);
        
        let errorMessage = error.message;
        try {
          const errorObj = JSON.parse(error.message);
          errorMessage = errorObj.error || error.message;
        } catch (e) {
          // Si no es JSON, usar el mensaje original
        }
        
        alert(`Error al transferir a Cloudflare: ${errorMessage}`);
        
        transferProgress.style.display = "none";
        btnTransferir.disabled = false;
        btnTransferir.textContent = 'Transferir a Cloudflare';
      }
    }

async function enviarIndice(indice) {
  try {
    const response = await fetch("https://proyect-cloud-flare.apiprueba2025.workers.dev/registrar-indice", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        nombreSerie: indice.nombreSerie,
        nombresec: indice.nombreIngles || indice.nombresec || null,    // <-- mapeo
        nombresec02: indice.nombreJapones || indice.nombresec02 || null,
        a√±o: indice.anio || indice.a√±o || null,
        categoria: indice.categoria || null,
        idioma: indice.idioma || null,
        imagen: indice.imagen || null,
        sitio: indice.sitio || null,
        sitio02: indice.sitio02 || null
      }),
    });

    if (!response) {
      return { ok: false, error: "No se recibi√≥ respuesta del servidor" };
    }

    const data = await response.json().catch(() => ({}));

    if (!response.ok) {
      return { ok: false, error: data?.error || response.statusText };
    }

    return { ok: true, data };
  } catch (error) {
    return { ok: false, error: error.message };
  }
}


    // Funciones para depuraci√≥n
    document.getElementById('btnToggleDebug').addEventListener('click', function() {
      const debugInfo = document.getElementById('debugInfo');
      debugInfo.style.display = debugInfo.style.display === 'none' ? 'block' : 'none';
    });

    function actualizarDebugInfo(title, data) {
      const debugContent = document.getElementById('debugContent');
      const timestamp = new Date().toLocaleTimeString();
      debugContent.innerHTML += `<div><strong>${timestamp} - ${title}</strong><br>${JSON.stringify(data, null, 2)}</div><hr>`;
      debugContent.scrollTop = debugContent.scrollHeight;
    }

    // Limpiar tabla
    document.getElementById('btnLimpiar').addEventListener('click', function() {
      datosFirebase = [];
      datosFiltrados = [];
      currentPage = 1;
      mostrarDatosEnTabla();
      actualizarEstadisticas();
      document.getElementById('btnTransferir').disabled = true;
      document.getElementById('pagination').style.display = 'none';
      document.getElementById('debugContent').innerHTML = '';
    });

    // Aplicar filtros
    document.getElementById('btnAplicarFiltro').addEventListener('click', aplicarFiltros);
    
    function aplicarFiltros() {
      const filterSerie = document.getElementById('filterSerie').value.toLowerCase();
      const filterNombreIngles = document.getElementById('filterNombreIngles').value.toLowerCase();
      const filterNombreJapones = document.getElementById('filterNombreJapones').value.toLowerCase();
      const filterCategoria = document.getElementById('filterCategoria').value.toLowerCase();
      
      datosFiltrados = datosFirebase.filter(item => {
        const serieMatch = !filterSerie || item.nombreSerie.toLowerCase().includes(filterSerie);
        const nombreInglesMatch = !filterNombreIngles || (item.nombreIngles && item.nombreIngles.toLowerCase().includes(filterNombreIngles));
        const nombreJaponesMatch = !filterNombreJapones || (item.nombreJapones && item.nombreJapones.toLowerCase().includes(filterNombreJapones));
        const categoriaMatch = !filterCategoria || (item.categoria && item.categoria.toLowerCase().includes(filterCategoria));
        
        return serieMatch && nombreInglesMatch && nombreJaponesMatch && categoriaMatch;
      });
      
      currentPage = 1;
      mostrarDatosEnTabla();
      actualizarEstadisticas();
      actualizarPaginacion();
    }

    // Limpiar filtros
    document.getElementById('btnLimpiarFiltro').addEventListener('click', function() {
      document.getElementById('filterSerie').value = '';
      document.getElementById('filterNombreIngles').value = '';
      document.getElementById('filterNombreJapones').value = '';
      document.getElementById('filterCategoria').value = '';
      datosFiltrados = [...datosFirebase];
      currentPage = 1;
      mostrarDatosEnTabla();
      actualizarEstadisticas();
      actualizarPaginacion();
    });
  </script>
</body>
</html>